<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= appName %></title>
    <meta name="description" content="<%= appDescription %>">
    <link rel="stylesheet" href="/css/index.css?v=20241213-002">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon/icon-512.png">
</head>
<body>
    <div id="root"></div>
    <script type="module" nonce="<%= scriptNonce %>" src="/js/<%= scriptName %>.js"></script>
    <script nonce="<%= scriptNonce %>">
      // Register service worker with network-first strategy for JS files
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('[PWA] Service worker registered:', registration.scope);

              // Check for updates immediately
              registration.update();

              // Auto-update service worker when new version available
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[PWA] New version available, will activate on next reload');
                    // Automatically skip waiting to activate new SW
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                  }
                });
              });

              // Reload page when new service worker takes control
              let refreshing = false;
              navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                  refreshing = true;
                  console.log('[PWA] Service worker updated, reloading page');
                  window.location.reload();
                }
              });
            })
            .catch(err => {
              console.error('[PWA] Service worker registration failed:', err);
            });
        });
      }
    </script>
</body>
</html>
